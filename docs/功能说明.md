# 项目功能说明

> 本文档梳理当前仓库的主要功能、路由结构、SEO/Sitemap、登录逻辑以及运行与配置方式，便于功能对齐与后续扩展。

## 1. 项目概览
- 技术栈：Next.js App Router（Next 15）、TypeScript（严格模式）、React 19、Tailwind（v4）。
- 路由结构：采用 App Router（`src/app`）。本地化（i18n）采用目录前缀：默认 `en`，中文 `zh`。
- Shaders 支持：Webpack 配置 `glslify-loader` + `raw-loader`，支持导入 `.glsl/.vert/.frag` 等文件，公用 GLSL 放在 `src/lib/glsl/`。
- 教程内容：文件型内容源，位于 `src/lib/tutorials/<category>/<tutorial-id>/`，包含 `config.json`、`en-README.md`、`zh-README.md`、着色器源码等。
- 分析统计：根布局内含 Google Analytics gtag 脚本。

## 2. 主要功能
- 多语言站点（中/英）：
  - 默认语言 `en` 对应根路径（`/`），中文在 `/zh` 前缀下镜像。
  - 页面级 SEO 元信息（`generateMetadata`）按 locale 输出 `title/description/alternates/openGraph/twitter` 等。
- 教程系统：
  - 列表页：`/learn` 与 `/zh/learn` 展示教程目录（服务端读取教程内容元数据）。
  - 详情页：`/[locale]/learn/[category]/[id]`（已存在目录结构与客户端组件，权限策略见“登录逻辑”与“SEO”章节）。
- 静态内容页：
  - 英文根路径：`/about`、`/examples`、`/glslify-guide`。
  - 本地化版本：`/[locale]/about`、`/[locale]/examples`、`/[locale]/glslify-guide`。
- 站点地图与 Robots：
  - `public/sitemap.xml`（生成脚本产出）、`/sitemap-index.xml`（动态路由），`/robots.txt`（动态路由）。
- 登录与会话（Google）：
  - NextAuth（v4）Google Provider，API 路由：`/api/auth/[...nextauth]`。
  - 登录页：`/login`，支持 `?callbackUrl=/xxx` 回跳，默认回首页 `/`。
  - 顶部导航：未登录显示“Login”，已登录显示“Logout”，刷新后保持登录态。

## 3. 路由清单（核心）
- 公共页：
  - `/`（英文首页）
  - `/learn`（英文教程列表）
  - `/about`、`/examples`、`/glslify-guide`（英文静态页）
  - `/[locale]`、`/[locale]/learn`、`/[locale]/about`、`/[locale]/examples`、`/[locale]/glslify-guide`
- 教程详情：
  - `/[locale]/learn/[category]/[id]`
- 登录/认证：
  - `/login`（自定义登录页）
  - `/api/auth/providers`、`/api/auth/signin`、`/api/auth/callback/google`、`/api/auth/session`（NextAuth 内置）
- SEO：
  - `/sitemap.xml`（静态文件）
  - `/sitemap-index.xml`（动态路由）
  - `/robots.txt`（动态路由）

## 4. i18n 与中间件
- 语言集：`locales = ['en','zh']`，默认 `en`。
- 中间件 `middleware.ts`：
  - 排除静态与核心 SEO 路由（如 `_next/static`、`sitemap.xml`、`sitemap-index.xml`、`robots.txt` 等），避免被误处理。
  - 当前中间件不做强制本地化重定向，页面组件负责自身 i18n。

## 5. SEO 与 Sitemap
- 元数据：
  - `src/app/[locale]/layout.tsx`、各页面 `generateMetadata` 输出 `title/description/alternates/openGraph/twitter/robots`。
  - 根布局含结构化数据组件 `StructuredData`（website/organization）。
- Robots：
  - `/robots.txt` 动态输出，包含 `Sitemap` 指向与抓取策略。
- Sitemap：
  - 脚本：`scripts/generate-sitemap.js` + `scripts/sitemap-utils.js`，命令：`pnpm xml` 生成 `public/sitemap.xml`。
  - 另有 `src/app/sitemap-index.xml/route.ts` 动态返回索引页，指向 `sitemap.xml`。
- 生产建议：
  - 配置 `NEXT_PUBLIC_BASE_URL` 与实际生产域完全一致（含 https 以及 www/非 www），避免 GSC 报“重定向”。

## 6. 登录逻辑（Google / NextAuth v4）
- 依赖：`next-auth@^4.24.7`。
- API：`src/app/api/auth/[...nextauth]/route.ts` 内联配置 Google Provider：
  - 显式设置 `authorization/token/userinfo` 端点，规避 OIDC 发现超时。
  - 通过 `openid-client` 可调超时（默认 10s，可用 `NEXTAUTH_OAUTH_TIMEOUT_MS`），并在存在代理变量时走代理（`HTTPS_PROXY`/`HTTP_PROXY`）。
- 登录页：`/login`
  - 按钮使用 `signIn('google')` 发起认证，默认回首页；如携带 `callbackUrl` 则回原页。
- 顶部导航：
  - `Login`：仅未登录显示（客户端查询 `/api/auth/session` 判断）。
  - `Logout`：仅已登录显示，`signOut({ callbackUrl: '/' })`。
- 环境变量：
  - `GOOGLE_CLIENT_ID`、`GOOGLE_CLIENT_SECRET`、`NEXTAUTH_SECRET`、`NEXTAUTH_URL=http://localhost:3000`（本地）
  - 生产环境 `NEXTAUTH_URL` 必须是站点根（不要包含路径），否则 `providers` URL 会异常。
- 连通性注意：
  - 若 Node 端到 Google 域名网络受限，会出现 `ETIMEDOUT`。可设置系统/会话代理环境变量后再启动 `pnpm dev`。

## 7. 教程内容源与数据约定
- 目录结构：`src/lib/tutorials/<category>/<tutorial-id>/`
  - `config.json`：建议字段
    - `id`: string（唯一）
    - `category`: string（如 `basic`/`animation`）
    - `difficulty`: string（`beginner`/`intermediate`/`advanced`）
    - `title`: { en, zh }
    - `description`: { en, zh }
  - `en-README.md`、`zh-README.md`
  - `fragment.glsl`、`fragment-exercise.glsl`（示例与练习）
- 公共 GLSL：`src/lib/glsl/` 下复用方法。
- 页面读取：列表页服务端读取 config/元数据，详情页展示对应内容与编辑器（已具备组件与样式基础）。

## 8. 构建与脚本
- 安装：`pnpm install`
- 开发：`pnpm dev`（Turbopack）
- 构建：`pnpm build`
- 启动：`pnpm start`
- Lint：`pnpm lint`
- 生成 Sitemap：`pnpm xml`（产出到 `public/sitemap.xml`）

## 9. 安全与配置
- 环境变量：使用 `.env.local`，避免提交敏感信息。
- 中间件排除：已排除 `sitemap.xml`、`sitemap-index.xml`、`robots.txt`、静态资源等，避免被错误重写或重定向。
- Robots：默认允许全站抓取，屏蔽 API、`/_next`、`/admin` 等敏感路径。

## 10. 已知问题与注意事项
- Google OAuth 网络连通性：
  - 若开发环境网络到 Google 不可达（或 DNS 劫持），需要设置代理。代码已支持通过 `HTTPS_PROXY/HTTP_PROXY` 与 `NEXTAUTH_OAUTH_TIMEOUT_MS` 微调。
- SEO 与权限：
  - 当前未对详情页做“摘要可见”/“墙后保护”的强限制（可按需要切换为“登录墙”或“SSR 跳转”策略）。
- 文案与本地化：
  - 登录/登出按钮默认英文文案；如需完善中文翻译，可在 `src/lib/translations.ts` 增补 `nav.login`/`nav.logout` 等键值。

## 11. 规划与后续（建议）
- 支付与权益（Creem 对接）：
  - Checkout API、Webhook 幂等、`Entitlement` 授权表、订阅管理入口。
- 详情页登录策略（两种可选，二选一）：
  1) SEO 友好：SSR 输出全文 + 客户端登录墙/前端跳转。
  2) 严格保护：SSR 仅输出摘要，受限正文需登录后获取。
- 数据持久化：
  - 引入 Prisma + Postgres（或 SQLite 开发态），落地 `User/Entitlement/Payment/Subscription/WebhookEvent`。
- 健康检查：
  - 增加服务端连通性 /health-oauth 端点，检测 Google OAuth 三个域的可达性与耗时。

---
如需我把以上“规划与后续”拆成任务清单（Issue 模板）或在 README 中增加“快速上手（登录/SEO/Sitemap）”小节，告诉我你的优先顺序，我会按模块细分落地步骤。

