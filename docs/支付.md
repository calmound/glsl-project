下面按序号把你“Next.js 接入 Creem 支付（含 Supabase 权限落库）”的任务拆成一套可执行清单。你可以按顺序逐项完成与验收。

---

## 1. Creem 侧准备

官方文档：https://docs.creem.io/getting-started/quickstart

1.1 创建产品/价格（拿到 `productId`）。
1.2 获取并保存两类密钥：

* `CREEM_API_KEY`（服务端调用）
* `CREEM_WEBHOOK_SECRET`（Webhook 验签）
  1.3 在 Creem Dashboard 确认 Test Mode 与 Production Mode 的切换规则与开关。

验收：你手里有 `productId`、API Key、Webhook Secret 三样。

productId = prod_7doLTrTiOnQrX9FrPW4sta
CREEM_API_KEY = creem_test_zjlHTBA4uji6wDTJVWUpm

---

## 2. Next.js 项目基础配置

2.1 安装 Creem Next.js 适配器依赖。
2.2 配置环境变量（本地 `.env.local`、线上环境变量管理）：

* `CREEM_API_KEY`
* `CREEM_WEBHOOK_SECRET`
  2.3 规划环境隔离：测试/生产分别一套 key/secret，并明确 `testMode` 开关。

验收：本地启动应用，环境变量读取正常（不在前端暴露）。

---

## 3. 创建 Checkout 服务端路由

3.1 在 Next.js（App Router）创建 Checkout Route Handler（GET），作为创建 checkout session 的服务端入口。
3.2 配置默认回跳地址 `successUrl`（生产必须是你的域名）。
3.3 启用 `testMode: true` 用于测试。

验收：访问页面点击购买按钮后，能跳转到 Creem Checkout。

---

## 4. 前端集成支付按钮

4.1 在前端页面使用 `CreemCheckout` 组件包裹按钮。
4.2 传入 `productId`。
4.3 关键：传入你的用户标识，用于后续 webhook 精确落库，例如：

* `referenceId = userId / tenantId`
* `metadata = { userId, plan, seatCount }`

验收：能从你的站点稳定跳转到 Creem，并且你能在回调事件里拿到用户标识。

---

## 5. Supabase 数据库改造（高层）

5.1 增加“权限/订阅状态”存储结构（例如 `entitlements`）：记录用户当前 plan、状态、到期时间、Creem customer/subscription 映射。
5.2 增加“支付事件”存储结构（例如 `payment_events`）：用于 webhook 幂等与审计（事件唯一键、事件类型、处理状态）。
5.3 明确你的授权规则：

* 什么时候授予（payment success / subscription active）
* 什么时候撤销（cancel / expired / failed）
* 取消后是否允许用到周期结束

验收：你能用数据库表达“谁是 Pro、有效期到哪、为什么变成 Pro”。

---

## 6. 创建 Webhook 服务端接口

6.1 在 Next.js 创建 Webhook Route Handler（POST）。
6.2 开启验签（用 `CREEM_WEBHOOK_SECRET`）。
6.3 核心处理顺序固定为：

* 先写入 `payment_events` 做幂等去重
* 再更新 `entitlements`（授予/撤销/续费/到期）
  6.4 Webhook 逻辑必须短、可重试、可幂等。

验收：重复投递同一事件，不会导致重复开通/重复扣权。

---

## 7. 配置 Creem Webhook URL

7.1 本地测试用 ngrok 暴露：

* `https://xxxx.ngrok.../api/webhook/creem`
  7.2 上线后改为生产域名：
* `https://your-domain.com/api/webhook/creem`
  7.3 在 Creem 控制台选定需要推送的事件类型（覆盖订阅生命周期）。

验收：Creem 能成功投递 webhook，你服务端能收到且返回 2xx。

---

## 8. 成功页与状态确认机制

8.1 `successUrl` 页面只展示“正在确认”，不直接改权限。
8.2 前端向你的后端查询当前用户 entitlement 状态（或轮询），直到变为 `active`。
8.3 若超时（例如 60–120 秒），提示用户刷新或联系客服，并保留订单/参考号。

验收：即使 webhook 延迟，用户体验仍正确；即使用户伪造访问 success URL，也不会误开通。

---

## 9. 在业务侧启用权限校验

9.1 你所有“付费功能开关”统一读取 Supabase 的 `entitlements`。
9.2 不把“是否 Pro”永久写死在前端或 token 里；必要时做短 TTL 缓存。
9.3 对 API 接口做服务端鉴权：未 `active` 则拒绝。

验收：权限变更（授予/撤销）后，功能访问立即按数据库状态生效。

---

## 10. 订阅管理入口（可选但推荐）

10.1 集成 Customer Portal（管理订阅、改卡、取消）。
10.2 Portal 链接必须按当前登录用户生成，并校验 customerId/subscriptionId 属主，避免越权。

验收：用户可自助取消/改卡；取消后 webhook 正确更新你的权限状态。

---

## 11. 测试计划

11.1 测试支付成功：开通权限。
11.2 测试支付失败：不授予权限。
11.3 测试取消订阅：按你的规则撤权或到期撤权。
11.4 测试 webhook 重试：幂等生效。
11.5 测试跨设备登录：权限一致。

验收：上述用例全通过，并能从数据库解释每一次状态变化。

---

## 12. 上线与运维

12.1 切换生产 key/secret，`testMode=false`。
12.2 确保 webhook 线上稳定可达（固定域名、监控、告警）。
12.3 日志与审计：记录事件类型、订阅/客户 ID、处理结果、失败原因。
12.4 制定 key/secret 轮换与回滚方案。

验收：生产环境可稳定收款、稳定开通、稳定对账与排查。

---

如果你愿意，我可以把上述任务进一步拆成“你当前进度到第几步、下一步该做什么”的短清单。你只要回复我：你现在已经完成了哪些（例如：1、2、3）。
